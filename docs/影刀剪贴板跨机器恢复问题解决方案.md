# 影刀剪贴板跨机器恢复问题解决方案

## 问题描述

在公司电脑运行 `ShadowbotAppFormwork_InstructDataPaste.py` 脚本时：
- `InstructData`（公司电脑保存的剪贴板）：可以正常恢复
- `InstructData_B`（家里电脑保存的剪贴板）：报错

**错误信息：**
```
格式 50070 (System.String): 46 字节
格式 50111 恢复失败: (6, 'SetClipboardData', '句柄无效。')
```

## 问题原因

**Windows 剪贴板自定义格式ID是机器相关的，不能跨机器直接使用。**

### 详细解释

在 Windows 系统中，像 `ShadowBot.Flow.Blocks`、`System.String` 这样的自定义剪贴板格式，它们的格式ID是在程序运行时**动态注册**的（通常从 49152 / 0xC000 开始递增）。

| 机器 | 格式名称 | 格式ID |
|------|----------|--------|
| 家里电脑 | System.String | 50070 |
| 公司电脑 | System.String | 50185（可能不同） |

当脚本直接使用保存的 `format_id=50111` 调用 `SetClipboardData()` 时，这个格式ID在公司电脑上：
1. 可能根本没注册
2. 或者注册了但对应的是完全不同的格式

所以系统返回 **"句柄无效"** 错误（错误码 6）。

### 为什么 InstructData 能成功？

因为 `InstructData` 是在**公司电脑**上保存的，格式ID和当前机器一致，所以能恢复。

### 这不是加密问题

数据本身没有加密。两个文件都包含相同的影刀 `programing.sleep` 等待指令，只是指令的 UUID 不同。

## 解决方案

修改脚本的恢复逻辑：**不要直接使用保存的 format_id，而是根据 format_name 在目标机器上重新注册获取正确的格式ID**。

### 代码修改

在 `ShadowbotAppFormwork_InstructDataPaste.py` 第 44-65 行，添加格式ID映射逻辑：

```python
# 恢复所有格式的数据
success_count = 0
for fmt_id, fmt_data in clipboard_data.items():
    try:
        format_id = fmt_data['format_id']
        format_name = fmt_data['format_name']
        data = fmt_data['data']

        # 处理自定义格式ID（>= 0xC000 即 49152）
        # 自定义格式ID是机器相关的，需要用格式名重新注册获取当前机器的正确ID
        actual_format_id = format_id
        if format_id >= 0xC000 and format_name and format_name.startswith('Format_') is False:
            try:
                # 用格式名在当前机器上注册/获取正确的格式ID
                actual_format_id = win32clipboard.RegisterClipboardFormat(format_name)
                if actual_format_id != format_id:
                    print(f"  ℹ️  格式 {format_name}: ID {format_id} -> {actual_format_id} (已映射)")
            except Exception as reg_err:
                print(f"  ⚠️  注册格式 {format_name} 失败: {reg_err}, 使用原ID")

        # 设置剪贴板数据
        win32clipboard.SetClipboardData(actual_format_id, data)
```

### 修改要点

1. 检查格式ID是否 >= `0xC000` (49152) — 这是 Windows 自定义剪贴板格式的起始ID
2. 如果是自定义格式（如 `System.String`、`ShadowBot.Flow.Blocks`），使用 `RegisterClipboardFormat(format_name)` 在当前机器上注册/获取正确的格式ID
3. 排除 `Format_1`、`Format_7` 这类通用格式名（因为这些名称无法正确注册）
4. 使用映射后的 `actual_format_id` 来设置剪贴板数据

## 修改后运行效果

```
📋 检测到 9 种剪贴板格式
  ℹ️  格式 System.String: ID 50070 -> 50185 (已映射)
  ✓ 格式 50070 (System.String): 46 字节
  ℹ️  格式 ShadowBot.Flow.Blocks: ID 50111 -> 50234 (已映射)
  ✓ 格式 50111 (ShadowBot.Flow.Blocks): 295 字节
  ...

✅ 成功恢复 9/9 种格式到剪贴板
```

## 涉及文件

| 文件路径 | 说明 |
|----------|------|
| `InstructData\InstructData\InstructData` | 公司电脑剪贴板数据 |
| `InstructData\InstructData\InstructData_B` | 家里电脑剪贴板数据 |
| `InstructData\InstructData\ShadowbotAppFormwork_InstructDataPaste.py` | 剪贴板恢复脚本（已修改） |

## 总结

Windows 剪贴板的自定义格式使用动态分配的格式ID，这些ID在不同机器上不一致。解决跨机器剪贴板数据恢复问题的关键是：**使用格式名称（format_name）而非格式ID（format_id）来识别和注册剪贴板格式**。

---
*文档生成时间：2026-02-02*
